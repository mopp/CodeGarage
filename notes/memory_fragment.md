# Fragmentation (フラグメンテーション) とは？
    * 主記憶装置 / 補助記憶装置 を管理するときに発生する問題
    * 記憶領域を有効活用できなくなるという問題
        * 有効活用ってなんやねんな
    * 簡単にいえばメモリが無駄になるということ
    * 以下、主記憶装置(メモリ)に話題を絞る
    * 日本語では断片化
    * コンピュータ上のメモリの管理上の一単位が、そのままでは有効利用できない状態になることを言う。 by Wikipedia
    * 解消するため、再配置を行うことをデフラグメンテーション（defragmentation, デフラグ）もしくはメモリ・コンパクション（memory compaction）と呼ぶ。
    * どのようにフラグメンテーションが起きるかは実際のアロケータに依存する
        * だからメモリアロケータを頑張る

# メモリに関する前提条件
    * メモリ空間は連続である
    * 管理したいFreeなメモリ領域も連続
    * 長方形をイメージ

## フラグメンテーションの種類
    * Internal fragmentation (内部フラグメンテーション)
        * 空き領域が分散すること
        * 確保したメモリ領域の中で起きるから`内部`フラグメンテーション
        * 固定長ブロック方式を採用すると必ず起きる
            * 要求されたメモリサイズにピッタリと合うブロックがないとき
            * 大きめのブロックを返さざるを得ない
            * 要求をした側は使用しないので、余分なところが無駄となる
        * 下記2つのフラグメンテーションと違い、解決が難しい
            * 通常の良い解決方法はアルゴリズムの抜本的変更
                * Dynamic memory allocation
                * Memory pool
    * External fragmentation (外部フラグメンテーション)
        * 空き領域が分散すること
        * 管理下のメモリの空き合計を計算すると、要求されたメモリサイズに応えられるのに
        * 小さな空き領域が管理空間上に散らばっているためにメモリ割当できない状況
        * 再配置により解決可能
        * 割合計算
            * 1 - (最大の空きブロックサイズ) / (全体の空き)
        * 仮想メモリによる物理メモリのフラグメンテーション解決は可能
            * 複数の分散した物理メモリ領域を普通に連続な仮想メモリ空間にマッピングしてやるだけ
    * Data fragmentation
        * 専有している領域が分散すること
        * メモリ上のデータのコレクションがバラバラのフラグメントとして配置されていること
            * メモリ局所性を満たさない
        * 外部フラグメンテーションと同じで再配置により解決可能
# 影響
    * オーバーヘッドとメモリの無駄という点で内部フラグメンテーションのほうが、外部フラグメンテーションよりも影響が少ない

# フラグメンテーションによって生じる問題
    * メモリの確保失敗
        * 合計空きメモリが要求を満たすのに、外部フラグメンテーションによりメモリを返せないときのOSの戦略
            * 再配置を行う
                * 実行コスト/実装コストやばそう
            * プロセスを殺して強制的にメモリを空ける
                * 一人を犠牲にしてみんなが幸せに
            * 要求元プロセスを停止させる
                * 別プロセスがメモリを返してくるまで待つ
                * いつ再開できるかわからん
                * デッドロックが起きうる
            * 適当なプロセスをスワップアウトする
            * 諦めて落ちる
    * パフォーマンスが下がる
        * ディスクストレージの場合
            * シークコストがかかる
        * フラグメントが多いと空き領域を探すループの実行コストがかかる
        * 小さいフラグメントをまとめて一つにするのも実行コストがかかる
            * これにより更にフラグメントの問題の解決コストが増加する？

# 類似した現象
    * プロセス管理などでも外部フラグメントは起きる
        * タイムシェアリング方式のマルチタスクで、プロセスがブロックされているかを考慮しないプロセスマネージャの場合
        * プロセスがブロックされて(例えばIO待ちとか)の場合でも考慮しないので割当時間を使ってしまい
        * 実行リソースの割当が不公平になる
            * busy waitだろうか？
        * これをタイムシェアリング方式の内部フラグメンテーションという
        * タイムシェアリング方式自身が外部フラグメンテーションみたいなもの？
            * タイムシェアリングせず、邪魔されずに単一プロセスが実行される場合と比較すると
            * 時間分割すること自体がフラグメントとなる？
                * fragmented time slices
            * CPUのコンテキストスイッチコスト、キャッシュがフラッシュされるコスト

# そもそも、分断されると何が行けないの？
    * 参照の局所性
    * メモリは基本的に逐次的に実行されるもの
    * それができなくなるので、アクセス効率が悪くなる

# 所感
    * フラグメンテーション発生率と実装コストは反比例の関係にあると感じる (線形に比例かはわからない)
    * 確保したもののフラグメンテーションと空いているもののフラグメンテーションに大別できるのではないだろうか
        * 第三のdata fragmentationがこれか？
        * FATでよく言う断片化は空き領域ではなく、ファイルの断片化であるよな？ (要確認)
        * ファイルの断片化以外にももちろん空き領域の断片化も起こりうる
        * というかファイルを断片化して保存することを許容したFATがよくないのではないか

# 参考文献
https://en.wikipedia.org/wiki/Fragmentation_(computing)
https://ja.wikipedia.org/wiki/%E5%8F%82%E7%85%A7%E3%81%AE%E5%B1%80%E6%89%80%E6%80%A7
